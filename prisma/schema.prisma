generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id                    String       @id @default(uuid())
  nome                  String
  cpf                   String       @unique
  telefone              String       @unique
  email                 String?      @unique
  genero                String?
  estado_civil          String?
  nascimento            DateTime?
  criado_em             DateTime     @default(now())
  priority_list         Boolean      @default(false)
  priority_list_course_id String?
  priority_list_added_at DateTime?
  cidade_preferencia    String?
  Attendance            Attendance[]
  enrollments           Enrollment[]
  Conversation          Conversation[]

  @@index([cpf])
  @@index([telefone])
  @@index([priority_list])
  @@map("students")
}

model Enrollment {
  id                      String    @id @default(uuid())
  student_id              String
  class_id                String
  criado_em               DateTime  @default(now())
  status                  String    @default("ativo")
  concluido_em            DateTime?
  cancelado_em            DateTime?
  transferido_de_class_id String?
  Class                   Class     @relation(fields: [class_id], references: [id], onDelete: Cascade)
  student                 Student   @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@unique([student_id, class_id], map: "enrollments_student_id_class_id_key")
  @@index([student_id])
  @@index([class_id], map: "enrollments_class_id_idx")
  @@index([status])
  @@index([student_id, status])
  @@map("enrollments")
}

model Admin {
  id               String             @id @default(uuid())
  email            String             @unique
  password_hash    String
  role             String             @default("admin")
  criado_em        DateTime           @default(now())
  NotificationRead NotificationRead[]
  AuditLog         AuditLog[]         @relation("Actor")
  Message          Message[]          @relation("AdminMessages")

  @@map("admins")
}

model Attendance {
  id              String    @id
  session_id      String
  student_id      String
  presente        Boolean   @default(true)
  observacao      String?
  criado_em       DateTime  @default(now())
  lida_por_admin  Boolean   @default(false)
  lida_em         DateTime?
  Session         Session   @relation(fields: [session_id], references: [id], onDelete: Cascade)
  students        Student   @relation(fields: [student_id], references: [id], onDelete: Cascade)

  @@unique([session_id, student_id])
  @@index([session_id])
  @@index([student_id])
  @@index([lida_por_admin])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model Class {
  id               String       @id(map: "classs_pkey")
  notion_id        String?
  grupo_repense    GrupoRepense
  modelo           ModeloCurso
  capacidade       Int
  numero_inscritos Int          @default(0)
  eh_ativo         Boolean      @default(true)
  eh_16h           Boolean      @default(false)
  link_whatsapp    String?
  data_inicio      DateTime?
  horario          String?
  eh_mulheres      Boolean      @default(false)
  cidade           String?
  teacher_id       String?
  numero_sessoes   Int          @default(8)
  atualizado_em    DateTime     @default(now())
  arquivada        Boolean      @default(false)
  final_report     String?
  final_report_em  DateTime?
  Teacher          Teacher?     @relation(fields: [teacher_id], references: [id])
  Session          Session[]
  enrollments      Enrollment[]
  Conversation     Conversation[]

  @@index([teacher_id])
  @@index([eh_ativo])
  @@index([arquivada])
  @@index([cidade])
  @@map("Class")
}

model Session {
  id            String       @id
  class_id      String
  numero_sessao Int
  data_sessao   DateTime
  relatorio     String?
  criado_em     DateTime     @default(now())
  Attendance    Attendance[]
  Class         Class        @relation(fields: [class_id], references: [id], onDelete: Cascade)

  @@unique([class_id, numero_sessao])
  @@index([class_id])
  @@index([class_id, data_sessao])
}

model Teacher {
  id                     String                   @id
  nome                   String
  email                  String                   @unique
  password_hash          String
  telefone               String
  eh_ativo               Boolean                  @default(true)
  criado_em              DateTime                 @default(now())
  Class                  Class[]
  Message                Message[]                @relation("TeacherMessages")
  TeacherNotificationRead TeacherNotificationRead[]

  @@index([eh_ativo])
}

model TeacherNotificationRead {
  id               String   @id @default(uuid())
  teacher_id       String
  notification_type String  // 'leader_message'
  reference_id     String   // conversation id
  read_at         DateTime?
  criado_em        DateTime @default(now())
  Teacher         Teacher  @relation(fields: [teacher_id], references: [id], onDelete: Cascade)

  @@unique([teacher_id, notification_type, reference_id])
  @@index([teacher_id, notification_type])
  @@index([teacher_id, read_at])
  @@map("teacher_notification_reads")
}

model Conversation {
  id         String    @id @default(uuid())
  class_id   String
  student_id String?
  criado_em  DateTime  @default(now())
  Class      Class     @relation(fields: [class_id], references: [id], onDelete: Cascade)
  Student    Student?  @relation(fields: [student_id], references: [id], onDelete: Cascade)
  Message    Message[]

  @@unique([class_id, student_id], map: "conversations_class_id_student_id_key")
  @@index([class_id])
  @@index([class_id, student_id])
  @@map("conversations")
}

model Message {
  id               String       @id @default(uuid())
  conversation_id  String
  body             String
  sender_type      String       // 'admin' | 'teacher'
  sender_admin_id  String?
  sender_teacher_id String?
  criado_em        DateTime     @default(now())
  Conversation     Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  Admin            Admin?       @relation("AdminMessages", fields: [sender_admin_id], references: [id], onDelete: SetNull)
  Teacher          Teacher?    @relation("TeacherMessages", fields: [sender_teacher_id], references: [id], onDelete: SetNull)

  @@index([conversation_id])
  @@index([conversation_id, criado_em])
  @@map("messages")
}

model AuditLog {
  id            String   @id @default(uuid())
  event_type    String
  actor_id      String?
  actor_type    String?
  target_entity String?
  target_id     String?
  action        String?
  metadata      Json?
  ip_address    String?
  user_agent    String?
  status        String   @default("success")
  error_message String?
  criado_em     DateTime @default(now())

  Actor Admin? @relation("Actor", fields: [actor_id], references: [id])

  @@index([event_type, criado_em])
  @@index([actor_id, criado_em])
  @@index([target_entity, target_id])
  @@index([criado_em])
  @@map("audit_logs")
}

model NotificationRead {
  id              String   @id @default(uuid())
  admin_id        String
  notification_type String  // 'student_observation', 'session_report', 'final_report'
  reference_id    String   // ID of Attendance, Session, or Class
  read_at         DateTime?
  criado_em       DateTime @default(now())
  Admin           Admin    @relation(fields: [admin_id], references: [id], onDelete: Cascade)

  @@unique([admin_id, notification_type, reference_id])
  @@index([admin_id, notification_type])
  @@index([reference_id])
  @@index([admin_id, read_at])
  @@map("notification_reads")
}

enum GrupoRepense {
  Igreja
  Espiritualidade
  Evangelho
}

enum ModeloCurso {
  online
  presencial
}
